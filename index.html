<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV File Viewer, Sorter, and Filter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        #container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 10px;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>

<div id="container">
    <h2>CSV File Viewer, Sorter, and Filter</h2>
    
    <input type="file" id="csvFileInput" accept=".csv">
    
    <table id="csvTable"></table>
    
    <label for="sortColumn">Sort by column:</label>
    <select id="sortColumn"></select>

    <div id="filters"></div>
    
    <button onclick="sortAndSave()">Sort and Save</button>
</div>

<script>
    var headers = [];

    document.getElementById('csvFileInput').addEventListener('change', function(e) {
        var file = e.target.files[0];
        if (!file) {
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var contents = e.target.result;
            displayCSV(contents);
        };
        reader.readAsText(file);
    });

    function displayCSV(csv) {
        var lines = csv.split('\n');
        var table = document.getElementById('csvTable');
        var sortSelect = document.getElementById('sortColumn');
        var filtersDiv = document.getElementById('filters');
        table.innerHTML = ''; // Clear existing table
        sortSelect.innerHTML = ''; // Clear existing select options
        filtersDiv.innerHTML = ''; // Clear existing filters
        
        headers = lines[0].split(',');
        lines.forEach(function(line, index) {
            var row = table.insertRow();
            line.split(',').forEach(function(cell, cellIndex) {
                var cellElement = document.createElement(index === 0 ? 'th' : 'td');
                cellElement.textContent = cell;
                if (index === 0) {
                    var option = document.createElement('option');
                    option.text = cell;
                    option.value = cellIndex;
                    sortSelect.add(option);
                    // Add filter inputs
                    var filterInput = document.createElement('input');
                    filterInput.type = 'text';
                    filterInput.placeholder = 'Filter ' + cell;
                    filterInput.setAttribute('data-index', cellIndex);
                    filterInput.addEventListener('input', applyFilters);
                    filtersDiv.appendChild(filterInput);
                }
                row.appendChild(cellElement);
            });
        });
    }

    function applyFilters() {
        var filterInputs = document.querySelectorAll('#filters input');
        var table = document.getElementById('csvTable');
        var rows = table.rows;
        
        for (var i = 1; i < rows.length; i++) {
            var row = rows[i];
            var visible = true;
            for (var j = 0; j < filterInputs.length; j++) {
                var columnIndex = parseInt(filterInputs[j].getAttribute('data-index'));
                var filterValue = filterInputs[j].value.toLowerCase();
                var cellValue = row.cells[columnIndex].textContent.toLowerCase();
                if (!cellValue.includes(filterValue)) {
                    visible = false;
                    break;
                }
            }
            row.style.display = visible ? '' : 'none';
        }
    }

    function sortAndSave() {
        var sortIndex = document.getElementById('sortColumn').value;
        var table = document.getElementById('csvTable');
        var rows = Array.from(table.rows).slice(1); // Exclude header row
        rows.sort(function(a, b) {
            var aVal = a.cells[sortIndex].textContent;
            var bVal = b.cells[sortIndex].textContent;
            return aVal.localeCompare(bVal);
        });
        
        // Reorder table rows
        table.innerHTML = ''; // Clear existing table
        rows.forEach(function(row) {
            table.appendChild(row);
        });

        // Convert sorted table back to CSV and display it
        var csvContent = Array.from(table.rows).map(function(row) {
            return Array.from(row.cells).map(function(cell) {
                return cell.textContent;
            }).join(',');
        }).join('\n');
        
        alert("Sorted Data:\n\n" + csvContent);

        // Create a blob from the CSV content
        var blob = new Blob([csvContent], { type: 'text/csv' });

        // Create a link element to trigger the download
        var link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = 'sorted_data.csv';
        link.click();
    }
</script>

</body>
</html>
